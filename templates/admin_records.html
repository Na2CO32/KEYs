<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>å€Ÿé‚„å¯©æ ¸ä¸­å¿ƒ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body class="bg-slate-50 p-6">
    <div class="max-w-6xl mx-auto">
        <div class="flex justify-between items-center mb-8">
            <div class="flex items-center space-x-4">
                <a href="/" class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg font-bold hover:bg-slate-300 transition flex items-center">
                    ğŸ  è¿”å›ç³»çµ±é¦–é 
                </a>
                <h1 class="text-3xl font-bold text-slate-800">ğŸ“‹ å€Ÿé‚„å¯©æ ¸ä¸­å¿ƒ</h1>
            </div>
            <div class="space-x-2">
                <a href="/admin/keys" class="bg-blue-50 text-blue-600 px-4 py-2 rounded-lg font-bold hover:bg-blue-100 transition">âš™ï¸ é‘°åŒ™ç®¡ç†</a>
                <a href="/logout" class="text-slate-400 hover:text-red-500">ç™»å‡º</a>
            </div>
        </div>

        <div class="bg-white shadow-xl rounded-2xl overflow-hidden border border-slate-200">
            <table class="min-w-full">
                <thead class="bg-slate-800 text-white">
                    <tr>
                        <th class="px-6 py-4 text-left text-sm font-semibold italic">å€Ÿç”¨äºº</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold">ç§Ÿå€Ÿæ—¥æœŸ/æ™‚æ®µ</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold">é‘°åŒ™ç·¨è™Ÿ</th>
                        <th class="px-6 py-4 text-left text-sm font-semibold text-center">ç•¶å‰ç‹€æ…‹</th>
                        <th class="px-6 py-4 text-center text-sm font-semibold">ç®¡ç†æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                    {% for item in records %}
                    <tr class="hover:bg-slate-50 transition">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-800">{{ item.name }}</div>
                            <div class="text-xs text-slate-400">{{ item.phone }}</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-slate-600">
                            {{ item.date }}<br>
                            <span class="text-xs text-blue-500 font-medium">{{ item.slots|join(', ') if item.slots is iterable else item.slots }}</span>
                        </td>
                        <td class="px-6 py-4 font-mono text-blue-600 font-bold">{{ item.key_id }}</td>
                        <td class="px-6 py-4 text-center">
                            <span class="px-3 py-1 rounded-full text-xs font-bold
                                {% if item.status == 'å¯©æŸ¥ä¸­' %} bg-yellow-100 text-yellow-700
                                {% elif item.status == 'å·²å€Ÿå‡º' %} bg-green-100 text-green-700
                                {% elif item.status == 'å¾…ç¢ºèªæ­¸é‚„' %} bg-purple-100 text-purple-700
                                {% elif item.status == 'å·²æ­¸é‚„' %} bg-gray-100 text-gray-500
                                {% else %} bg-red-100 text-red-700 {% endif %}">
                                {{ item.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 text-center space-x-2">
                            {% if item.status == 'å¯©æŸ¥ä¸­' %}
                                <button onclick="confirmAction('{{item.phone}}', '{{item.key_id}}', '{{item.date}}', 'å·²å€Ÿå‡º')" 
                                        class="text-xs bg-green-600 text-white px-3 py-1.5 rounded-lg hover:bg-green-700 transition shadow-sm">
                                    æ ¸å‡†å€Ÿå‡º
                                </button>
                            {% elif item.status == 'å¾…ç¢ºèªæ­¸é‚„' %}
                                <button onclick="confirmAction('{{item.phone}}', '{{item.key_id}}', '{{item.date}}', 'å·²æ­¸é‚„')" 
                                        class="text-xs bg-slate-800 text-white px-3 py-1.5 rounded-lg hover:bg-black transition shadow-sm">
                                    ç¢ºèªæ­¸é‚„
                                </button>
                            {% elif item.status == 'å·²å€Ÿå‡º' %}
                                <span class="text-xs text-blue-400 italic">ç­‰å¾…ä½¿ç”¨è€…é‚„é‘°åŒ™...</span>
                            {% elif item.status == 'å·²æ­¸é‚„' %}
                                <span class="text-xs text-slate-400">âœ… æµç¨‹å·²çµæŸ</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% if not records %}
            <div class="p-10 text-center text-slate-400 italic">ç›®å‰æ²’æœ‰ä»»ä½•å€Ÿç”¨ç´€éŒ„</div>
            {% endif %}
        </div>
    </div>

    <script>
        // ç¼ºé™· 4: å…å¯†ç¢¼ï¼Œæ”¹ç‚ºå–®ç´”çš„ç¢ºèªè¦–çª—
        async function confirmAction(phone, keyId, date, target) {
            const result = await Swal.fire({
                title: 'ç¢ºèªè®Šæ›´ç‹€æ…‹ï¼Ÿ',
                text: `æ‚¨å³å°‡å°‡æ­¤ç­†ç´€éŒ„æ›´æ–°ç‚ºã€Œ${target}ã€`,
                icon: 'question',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'ç¢ºå®š',
                cancelButtonText: 'å–æ¶ˆ'
            });

            if (result.isConfirmed) {
                // é¡¯ç¤ºè®€å–ä¸­
                Swal.fire({
                    title: 'è™•ç†ä¸­...',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                const formData = new FormData();
                formData.append('phone', phone);
                formData.append('key_id', keyId);
                formData.append('date', date);
                formData.append('target_status', target);

                try {
                    // æ³¨æ„ï¼šAPI è·¯ç”±ä¸å†éœ€è¦å‚³é€ pwdï¼Œæ”¹ç”±å¾Œç«¯ Session é©—è­‰
                    const res = await fetch(`/admin/update_status`, { 
                        method: 'POST', 
                        body: formData 
                    });

                    if (res.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'æˆåŠŸ',
                            text: 'ç´€éŒ„å·²æ›´æ–°',
                            timer: 1000,
                            showConfirmButton: false
                        }).then(() => location.reload());
                    } else {
                        const errorData = await res.json();
                        Swal.fire('éŒ¯èª¤', errorData.message || 'æ›´æ–°å¤±æ•—ï¼Œè«‹æª¢æŸ¥æ¬Šé™', 'error');
                    }
                } catch (e) {
                    Swal.fire('éŒ¯èª¤', 'ç¶²è·¯é€£ç·šå¤±æ•—', 'error');
                }
            }
        }
    </script>
</body>
</html>